----------------------------win1251------------------------------
������ �������������� � LDAP ��� ������� 3prox� (�� windows,unix)
(c) Lopuchov Kirill lopuchov@mail.ru

			1. ������� �������� 

* �������������� ������ �������������� �������� ������� (basic)
* �������������� �������� ������� �� ������� ��� ����� ������������� 
  (� ����,�����,������) 
* �������������� �������� ������� �� �������� ��� ����� �������������
  (���� ������ ������ �� �������� ������) 

* �����c����� ����������� ���� �������������. 

 � ��������  ���������� ������� � ldap ������������ ���������� openldap,
������� ������ ����� ��������������� � �������� ��� �� Windows 98/2000/XP 
��� � �� ��������� unix �������� �������� �������� Linux,FreeBSD. 
��� ����� ����������������� ����������� �� ������� � Active Directory � 
�� ���������� ldap �� � �������� ������ �������� � �� ������ ldap ��������. 

��� ���������� � ������������ ��� �� Windows ������������� ����� Dev-C++
http://www.bloodshed.net/dev/ � ����� ��������� OpenLDAP for Windows 
http://lucas.bergmans.us/hacks/openldap/ 
������ openldap-2.2.29-db-4.3.29-openssl-0.9.8a-win32_Setup.exe,
������ ���� �� ���������� ���� � ��������� � �������.

��� unix �������� �� (Freebsd) ������������� ����������� gcc.
� ���������� openldap-client.

  

                           2. ��������� �������.

  2.1 ��� ����������� � LDAP ������� ������������ �������� ldapconnect .
������ �������� ��������� ip ����� ��� host ���  LDAP ������� ,
������ �������� ��� ������������ �� ����� ������ ����� ����������� 
��� ���������� ������ � ldap ��������� ����� ��� ����� �������������
� �������� �� �������������� � ��� ��� ���� ������, ������ �������� ��� 
������ ��� ����� ������������. 

� ������ ���������� � ���������� Active Directory ����� ������������ 
����� �������������� ��� ���������� ������ �������. � ������������ Open Ldap 
�������� ��� xNIX ����� ������������� ����� ��������� anonymous.

������:
ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap

  2.2 ��� ����������� � ����� ��������� ������ ������������� � ������ 
������ �������� ldapsbase 
������:
ldapsbase  cn=users,dc=domain,dc=ru

  2.3 �������� ldapattr ������ ��� ���������� ��������� ���������� �������.
a)������ �������� ���������� ������� "������������" � ��������� ldap ��������
  � Active Directory ��� ��� �������  "cn" , � ������ ldap �������� "uid". 
b)������ �������� ����������� ������� "������" � ��������� ldap ��������
  � Active Directory ��� ��� �������  "memberof" , � ������ ldap �������� "ou".
c)������ �������� ����� �� ������������ � ����� ��������� 0 ��� 1 
  1 - ��������, ��� ��� ����������� ������������  ���  �������� ��� ���� 
   ������������ �� ������� ��� ��� ����� ���������� � ������� ��������
  (����������: ������ ��� ���� ������������� �� ����������) .
  ���� �������� ������ ��� ���������� ������� ����� LDAP ������� ��� 
  ����������� �� �������� ���� ������������� � ���������.  

������:
ldapattr cn memberof 1

  2.4 �������� ldapaccess ������ ��� ����������� "��������" �����������
������������ ������ ������ ����������� �� http �������. � ��������� 
ldap �������� ��� �������� �������� "������" ��������� � �������� ldapattr.

������:
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru

��������: ��� Active Directory ��� ����� ������������ �������� � ������
internet. ������ ��� �������� ����� �� ������������ �������� � http 
����������� ������ �� ������ ������� � ��������� ������: 
(&(cn=���������������)(memberof=CN=internet,CN=Users,DC=domain,DC=ru))

  2.5 �������� ldapuserenv ������ ��� ������������ ������ ����� ������������ 
������� ��������  ������ ����������� � ldap. ������ ���������� ��� base DN
��� ������������. 

������:
ldapuserenv cn=users,dc=domain,dc=ru


 2.7 �������� ldaptrafgroup ������ ��� �������� ������� 
��� ����������� ������ ���� ����� ���� ��������� ������� �������.
a) ������ �������� ��� �������� ������  (�������� ldap �������� ) � �������
 ������ ������������.
b) ������ �������� �� ����� ������ ������������� ����������� �� ������
������� . ����� ����� ���� �� ��������� �������� "MONTHLY","DAILY","WEEKLY".
�) ������ �������� ��� ������ ������ � ���������� .
�) ��������� �������� ��� ����������� �� �������� � ���/���. 

������ ������������� ����������� �� ������������ ��������� � ������,
� �� �� ������ � �����. 
� ������ ������� � Active Directory ������� ������ � ������ traf200m
���� �������� ��� ������������ ������ ��������� ������ ����� 200 �����,
� ����� � �������� ������� 60000 ���/��� �� ������� ������������.

������:
ldaptrafgroup CN=traf200m,CN=Users,DC=domain,DC=ru MONTHLY 200 60000                        


�������� ��������� ��� ������� ������������ � ��������� �����,��� ������� 
�����������, ��� ��� ������������ � ���������� lc. ���������� ��������� 
���������� ��� � ������.

  2.6 �������� ldapdircount ������ ��� �������� ���������� ���� ����� 
�����������  ����� � ����������������� ����������. ���� � ���������� 
���� ����������� ������, ������ ��� �������� � ����������� �� ��.

������:
ldapdircount c:\nginx\counter\
ldapdircount /usr/nginx/counter/


����nginx3http
---------------------
# �������� ! �� ��������� ��� daemon ��� service ������ ���� ������ ������� 
# ����������������� �����,�� ���� �� �������� ����� ��������
daemon

# ��� win32
plugin "�nginxxy\ldapauth.dll" start
# ��� unix
plugin "/nginx/libldapauth.so" start

ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap
ldapsbase cn=users,dc=domain,dc=ru
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru
ldapuserenv cn=users,dc=domain,dc=ru
ldapdircount /nginx/counter/
ldapattr cn memberof 1

ldaptrafgroup CN=traf200m,CN=Users,DC=domain,DC=ru MONTHLY 200 60000
ldaptrafgroup CN=traf60d,CN=Users,DC=domain,DC=ru DAILY 60 80000
ldaptrafgroup CN=traf100w,CN=Users,DC=domain,DC=ru WEEKLY 100 80000

auth ldap
allow * * * *
http -p3128 -n
--------------------

��� �� �������� ��������� ������������ ��� ����� ������� � ����������� 
�� ��������.  
---------------------
service

plugin "�nginxxy\ldapauth.dll" start
ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap
ldapsbase cn=users,dc=domain,dc=ru
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru
ldapuserenv cn=users,dc=domain,dc=ru
ldapattr cn memberof 1
auth ldap
allow * * * *
http -p3128 -n
---------------------

                        �������� ������� ������� 

����� ����� ���� ��������� ACL �� ������ ������� ������������� ��������
� ��������� ������ �������� ldap ���������� ������� getldapuser
������ ������� ����� �������� 5 ���������� :

getldapuser < ldapserver basedn user_attribute filter user password > 

ldapserver - ��� ��� ip ����� LDAP �������
basedn  - �������� ����������� � LDAP (��������: cn=users,dc=domain,dc=com)
user_attribute - �������� ����������������� �������� (��������: 
		� Active Directory ��� cn � ������ LDAP ��������� �� ����� 
		��� ou)
filter - ������ �� ������ ������������ ����� ���������� �� LDAP (��������:
	 ��� Active Directory ������� ���� ������������� �������� � ������ 
	 internet ����� ��������� ������ 
	(memberOf=cn=internet,cn=Users,dc=domain,dc=com) )

user  -  ��� ������������ ��� ����������� � �������
password - ������ (���� ����)

 ������ ������nginx� getldapuser � 3http. 

���������� ���� ������ � icq  ������ ������������ ������������ . C������
� AD ������ icquser ������� ���� ������ �������������. 
������� bat ���� ���������� ���������� ������� ����� ����������� ���� 
c:\nginx\icquser �� ������� �������������:
-------------------------------------------
getldapuser 192.168.0.1 dc=domain,dc=com cn (memberOf=cn=icquser,cn=Users,dc=domain,dc=com) 
cn=admin,cn=users,dc=domain,dc=com password > c:\nginx\icquser
-------------------------------------------
��������� ������ bat ���� �� ������������� ����������. 

����� �nginx���� 3http.cfg ���� ������
-------------------------------------------------
monitor "c:\nginx\icquser"

auth ldap
allow $"c:\nginx\icquser" * *icq.com
deny * * *icq.com
allow *
http -n
-------------------------------------------------


			���������� ������� �� ��������� ��

	1) Win32 (windows 98/NT/XP/2000/2003)
��� ������ � ������ ������� � ������ � ��� ��� ���� � �������� ldapwindev 
��������� ���������� (������ 2.2.29).

 libcrypto.dll 
 liblber.dll
 libldap.dll
 libssl.dll
� ������������ �����
 lber.h
 lber_types.h
 ldap.h
 ldap_cdefs.h
 ldap_features.h
 ldap_schema.h
 ldap_utf8.h

����� ��� ���������� ������� � ���������� ���������� Dev-Cpp � ����� 
http://www.bloodshed.net/dev/

����� �����nginx����� ������ 3http ������:
http://nginx.ru/current/nginx-0.6-devel.tgz � �����������. 
� ������� \src\plugins ����������� ������� � ��������� �������� 
�������. ��������������� com-win32.bat ���� � ������ ���� ��� � ��� ����������
���������� gcc , ��������:
-------------com-win32.bat----------------
c:\Dev-Cpp\bin\gcc  -shared -o ldapauth.dll ldapauth.c -DWIN32 -I"./ldapwindev" -L"./ldapwindev" -lldap
------------------------------------------
� ��������� �� ���������� com-win32.bat ����� ����� � ��� ������ �������� 
���������� ldapauth.dll � ����������� ���� getldapuser.exe .
��� ���������� ������ ������������ ����� � ��� ���������� dll �� ��������  
ldapwindev ��������nginx������� � 3http.

	2) xNIX (linux,freebsd � �.�. )

����� ����������� ����� ��������� ����� � ������� ��� �c��������
OpenLDAP client. � ������� ������ ������������ ��������� 
����������:

 liblber.a
 libldap.a
 liblber.so
 libldap.so

� ������������ ����� 
 lber.h
 lber_types.h
 ldap.h
 ldap_cdefs.h
 ldap_features.h
 ldap_schema.h
 ldap_utf8.h

��������� ������� ��� ������� �� ��� �������� ���� ����������� �������� ������
���� ��������������� ������ ������� ������� �� �������� ������� ������� 
������������ ��� ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/

����� ������� �����, ���������� ������� ����� 
wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-2.3.9.tgz

������������� ����� 
tar xvzf openldap-2.3.9.tgz

� ��������� ������ ���������������� �� ���������� 
�����������:
./configure  --enable-backends=no --enable-slapd=no

����� 

make 
make install

����� �����nginx����� ������ 3http ������:
http://nginx.ru/current/nginx-0.6-devel.tgz � �����������. 
� ������� \src\plugins ����������� ������� � ��������� �������� 
�������. �������� ���� � ����� com-unix.sh ���������� ���������� -I � -L  
� ������������ �  ������������ ������ ldap ��� ����� �������.

��������� ��������� ��������:
chmod +x com-unix.sh
com-unix.sh

� ��������� �� ���������� com-unix.sh ����� ����� � ��� ������ �������� 
���������� ldapauth.so � ����������� ���� getldapuser.

������������ ��nginx��������� � ������� � 3http.
----------------------------win1251------------------------------
----------------------------KOI8-R------------------------------
������ �������������� � LDAP ��� ������� 3prox� (�� windows,unix)
(c) Lopuchov Kirill lopuchov@mail.ru

			1. ������� �������� 

* �������������� ������ �������������� �������� ������� (basic)
* �������������� �������� ������� �� ������� ��� ����� ������������� 
  (� ����,�����,������) 
* �������������� �������� ������� �� �������� ��� ����� �������������
  (���� ������ ������ �� �������� ������) 

* �����c����� ����������� ���� �������������. 

 � ��������  ���������� ������� � ldap ������������ ���������� openldap,
������� ������ ����� ��������������� � �������� ��� �� Windows 98/2000/XP 
��� � �� ��������� unix �������� �������� �������� Linux,FreeBSD. 
��� ����� ����������������� ����������� �� ������� � Active Directory � 
�� ���������� ldap �� � �������� ������ �������� � �� ������ ldap ��������. 

��� ���������� � ������������ ��� �� Windows ������������� ����� Dev-C++
http://www.bloodshed.net/dev/ � ����� ��������� OpenLDAP for Windows 
http://lucas.bergmans.us/hacks/openldap/ 
������ openldap-2.2.29-db-4.3.29-openssl-0.9.8a-win32_Setup.exe,
������ ���� �� ���������� ���� � ��������� � �������.

��� unix �������� �� (Freebsd) ������������� ����������� gcc.
� ���������� openldap-client.

  

                           2. ��������� �������.

  2.1 ��� ����������� � LDAP ������� ������������ �������� ldapconnect .
������ �������� ��������� ip ����� ��� host ���  LDAP ������� ,
������ �������� ��� ������������ �� ����� ������ ����� ����������� 
��� ���������� ������ � ldap ��������� ����� ��� ����� �������������
� �������� �� �������������� � ��� ��� ���� ������, ������ �������� ��� 
������ ��� ����� ������������. 

� ������ ���������� � ���������� Active Directory ����� ������������ 
����� �������������� ��� ���������� ������ �������. � ������������ Open Ldap 
�������� ��� xNIX ����� ������������� ����� ��������� anonymous.

������:
ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap

  2.2 ��� ����������� � ����� ��������� ������ ������������� � ������ 
������ �������� ldapsbase 
������:
ldapsbase  cn=users,dc=domain,dc=ru

  2.3 �������� ldapattr ������ ��� ���������� ��������� ���������� �������.
a)������ �������� ���������� ������� "������������" � ��������� ldap ��������
  � Active Directory ��� ��� �������  "cn" , � ������ ldap �������� "uid". 
b)������ �������� ����������� ������� "������" � ��������� ldap ��������
  � Active Directory ��� ��� �������  "memberof" , � ������ ldap �������� "ou".
c)������ �������� ����� �� ������������ � ����� ��������� 0 ��� 1 
  1 - ��������, ��� ��� ����������� ������������  ���  �������� ��� ���� 
   ������������ �� ������� ��� ��� ����� ���������� � ������� ��������
  (����������: ������ ��� ���� ������������� �� ����������) .
  ���� �������� ������ ��� ���������� ������� ����� LDAP ������� ��� 
  ����������� �� �������� ���� ������������� � ���������.  

������:
ldapattr cn memberof 1

  2.4 �������� ldapaccess ������ ��� ����������� "��������" �����������
������������ ������ ������ ����������� �� http �������. � ��������� 
ldap �������� ��� �������� �������� "������" ��������� � �������� ldapattr.

������:
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru

��������: ��� Active Directory ��� ����� ������������ �������� � ������
internet. ������ ��� �������� ����� �� ������������ �������� � http 
����������� ������ �� ������ ������� � ��������� ������: 
(&(cn=���������������)(memberof=CN=internet,CN=Users,DC=domain,DC=ru))

  2.5 �������� ldapuserenv ������ ��� ������������ ������ ����� ������������ 
������� ��������  ������ ����������� � ldap. ������ ���������� ��� base DN
��� ������������. 

������:
ldapuserenv cn=users,dc=domain,dc=ru


 2.7 �������� ldaptrafgroup ������ ��� �������� ������� 
��� ����������� ������ ���� ����� ���� ��������� ������� �������.
a) ������ �������� ��� �������� ������  (�������� ldap �������� ) � �������
 ������ ������������.
b) ������ �������� �� ����� ������ ������������� ����������� �� ������
������� . ����� ����� ���� �� ��������� �������� "MONTHLY","DAILY","WEEKLY".
�) ������ �������� ��� ������ ������ � ���������� .
�) ��������� �������� ��� ����������� �� �������� � ���/���. 

������ ������������� ����������� �� ������������ ��������� � ������,
� �� �� ������ � �����. 
� ������ ������� � Active Directory ������� ������ � ������ traf200m
���� �������� ��� ������������ ������ ��������� ������ ����� 200 �����,
� ����� � �������� ������� 60000 ���/��� �� ������� ������������.

������:
ldaptrafgroup CN=traf200m,CN=Users,DC=domain,DC=ru MONTHLY 200 60000                        


�������� ��������� ��� ������� ������������ � ��������� �����,��� ������� 
�����������, ��� ��� ������������ � ���������� lc. ���������� ��������� 
���������� ��� � ������.

  2.6 �������� ldapdircount ������ ��� �������� ���������� ���� ����� 
�����������  ����� � ����������������� ����������. ���� � ���������� 
���� ����������� ������, ������ ��� �������� � ����������� �� ��.

������:
ldapdircount c:\nginx\counter\
ldapdircount /usr/nginx/counter/


����nginx3http
---------------------
# �������� ! �� ��������� ��� daemon ��� service ������ ���� ������ ������� 
# ����������������� �����,�� ���� �� �������� ����� ��������
daemon

# ��� win32
plugin "�nginxxy\ldapauth.dll" start
# ��� unix
plugin "/nginx/libldapauth.so" start

ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap
ldapsbase cn=users,dc=domain,dc=ru
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru
ldapuserenv cn=users,dc=domain,dc=ru
ldapdircount /nginx/counter/
ldapattr cn memberof 1

ldaptrafgroup CN=traf200m,CN=Users,DC=domain,DC=ru MONTHLY 200 60000
ldaptrafgroup CN=traf60d,CN=Users,DC=domain,DC=ru DAILY 60 80000
ldaptrafgroup CN=traf100w,CN=Users,DC=domain,DC=ru WEEKLY 100 80000

auth ldap
allow * * * *
http -p3128 -n
--------------------

��� �� �������� ��������� ������������ ��� ����� ������� � ����������� 
�� ��������.  
---------------------
service

plugin "�nginxxy\ldapauth.dll" start
ldapconnect 192.160.0.1 cn=ldap,cn=users,dc=domain,dc=ru ldap
ldapsbase cn=users,dc=domain,dc=ru
ldapaccess CN=internet,CN=Users,DC=domain,DC=ru
ldapuserenv cn=users,dc=domain,dc=ru
ldapattr cn memberof 1
auth ldap
allow * * * *
http -p3128 -n
---------------------

                        �������� ������� ������� 

����� ����� ���� ��������� ACL �� ������ ������� ������������� ��������
� ��������� ������ �������� ldap ���������� ������� getldapuser
������ ������� ����� �������� 5 ���������� :

getldapuser < ldapserver basedn user_attribute filter user password > 

ldapserver - ��� ��� ip ����� LDAP �������
basedn  - �������� ����������� � LDAP (��������: cn=users,dc=domain,dc=com)
user_attribute - �������� ����������������� �������� (��������: 
		� Active Directory ��� cn � ������ LDAP ��������� �� ����� 
		��� ou)
filter - ������ �� ������ ������������ ����� ���������� �� LDAP (��������:
	 ��� Active Directory ������� ���� ������������� �������� � ������ 
	 internet ����� ��������� ������ 
	(memberOf=cn=internet,cn=Users,dc=domain,dc=com) )

user  -  ��� ������������ ��� ����������� � �������
password - ������ (���� ����)

 ������ ������nginx� getldapuser � 3http. 

���������� ���� ������ � icq  ������ ������������ ������������ . C������
� AD ������ icquser ������� ���� ������ �������������. 
������� bat ���� ���������� ���������� ������� ����� ����������� ���� 
c:\nginx\icquser �� ������� �������������:
-------------------------------------------
getldapuser 192.168.0.1 dc=domain,dc=com cn (memberOf=cn=icquser,cn=Users,dc=domain,dc=com) 
cn=admin,cn=users,dc=domain,dc=com password > c:\nginx\icquser
-------------------------------------------
��������� ������ bat ���� �� ������������� ����������. 

����� �nginx���� 3http.cfg ���� ������
-------------------------------------------------
monitor "c:\nginx\icquser"

auth ldap
allow $"c:\nginx\icquser" * *icq.com
deny * * *icq.com
allow *
http -n
-------------------------------------------------


			���������� ������� �� ��������� ��

	1) Win32 (windows 98/NT/XP/2000/2003)
��� ������ � ������ ������� � ������ � ��� ��� ���� � �������� ldapwindev 
��������� ���������� (������ 2.2.29).

 libcrypto.dll 
 liblber.dll
 libldap.dll
 libssl.dll
� ������������ �����
 lber.h
 lber_types.h
 ldap.h
 ldap_cdefs.h
 ldap_features.h
 ldap_schema.h
 ldap_utf8.h

����� ��� ���������� ������� � ���������� ���������� Dev-Cpp � ����� 
http://www.bloodshed.net/dev/

����� �����nginx����� ������ 3http ������:
http://nginx.ru/current/nginx-0.6-devel.tgz � �����������. 
� ������� \src\plugins ����������� ������� � ��������� �������� 
�������. ��������������� com-win32.bat ���� � ������ ���� ��� � ��� ����������
���������� gcc , ��������:
-------------com-win32.bat----------------
c:\Dev-Cpp\bin\gcc  -shared -o ldapauth.dll ldapauth.c -DWIN32 -I"./ldapwindev" -L"./ldapwindev" -lldap
------------------------------------------
� ��������� �� ���������� com-win32.bat ����� ����� � ��� ������ �������� 
���������� ldapauth.dll � ����������� ���� getldapuser.exe .
��� ���������� ������ ������������ ����� � ��� ���������� dll �� ��������  
ldapwindev ��������nginx������� � 3http.

	2) xNIX (linux,freebsd � �.�. )

����� ����������� ����� ��������� ����� � ������� ��� �c��������
OpenLDAP client. � ������� ������ ������������ ��������� 
����������:

 liblber.a
 libldap.a
 liblber.so
 libldap.so

� ������������ ����� 
 lber.h
 lber_types.h
 ldap.h
 ldap_cdefs.h
 ldap_features.h
 ldap_schema.h
 ldap_utf8.h

��������� ������� ��� ������� �� ��� �������� ���� ����������� �������� ������
���� ��������������� ������ ������� ������� �� �������� ������� ������� 
������������ ��� ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/

����� ������� �����, ���������� ������� ����� 
wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-2.3.9.tgz

������������� ����� 
tar xvzf openldap-2.3.9.tgz

� ��������� ������ ���������������� �� ���������� 
�����������:
./configure  --enable-backends=no --enable-slapd=no

����� 

make 
make install

����� �����nginx����� ������ 3http ������:
http://nginx.ru/current/nginx-0.6-devel.tgz � �����������. 
� ������� \src\plugins ����������� ������� � ��������� �������� 
�������. �������� ���� � ����� com-unix.sh ���������� ���������� -I � -L  
� ������������ �  ������������ ������ ldap ��� ����� �������.

��������� ��������� ��������:
chmod +x com-unix.sh
com-unix.sh

� ��������� �� ���������� com-unix.sh ����� ����� � ��� ������ �������� 
���������� ldapauth.so � ����������� ���� getldapuser.

������������ ��nginx��������� � ������� � 3http.
----------------------------KOI8-R------------------------------